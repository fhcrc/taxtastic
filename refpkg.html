<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Creating and manipulating refpkgs &#8212; taxtastic  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/classic.css?v=def86cc0" />
    
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="The Python Refpkg API" href="refpkg_api.html" />
    <link rel="prev" title="Manipulating the NCBI taxonomy" href="taxonomy.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="refpkg_api.html" title="The Python Refpkg API"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="taxonomy.html" title="Manipulating the NCBI taxonomy"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">taxtastic  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Creating and manipulating refpkgs</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="creating-and-manipulating-refpkgs">
<h1>Creating and manipulating refpkgs<a class="headerlink" href="#creating-and-manipulating-refpkgs" title="Link to this heading">¶</a></h1>
<section id="quickstart">
<h2>Quickstart<a class="headerlink" href="#quickstart" title="Link to this heading">¶</a></h2>
<p>The refpkgs is a container format for keeping all the miscellaneous files required to run <a class="reference external" href="http://matsen.fhcrc.org/pplacer">pplacer</a> in one place.  Roughly, it is a directory containing files and JSON file describing the other contents.  Refpkgs can be created and manipulated either from the commandline with subcommands of <code class="docutils literal notranslate"><span class="pre">taxit</span></code>, or from Python using an API exposed by the module <code class="docutils literal notranslate"><span class="pre">taxtastic.refpkg</span></code>.</p>
<p>To create an empty refpkg from Python, you would write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">taxtastic.refpkg</span> <span class="kn">import</span> <span class="n">Refpkg</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">Refpkg</span><span class="p">(</span><span class="s1">&#39;/path/to/new/refpkg&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If there had already been a refpkg at <code class="docutils literal notranslate"><span class="pre">/path/to/new/refpkg</span></code>, <code class="docutils literal notranslate"><span class="pre">r</span></code> would contain a reference to the existing refpkg afterwards.  If it doesn’t exist, it is created.  For historical reasons, the command line interface requires that you specify a locus to be recorded in the refpkg’s metadata:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">taxit</span> <span class="n">create</span> <span class="o">-</span><span class="n">l</span> <span class="n">locus_name</span> <span class="o">-</span><span class="n">P</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">new</span><span class="o">/</span><span class="n">refpkg</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">taxit</span> <span class="pre">create</span></code> takes many other arguments to add particular files that <code class="docutils literal notranslate"><span class="pre">pplacer</span></code> expects, but we won’t go into them here.  To add a file to a refpkg, we specify a key which it will be added under (refpkgs act as key-value stores) and the file to add.  With the API, this is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;/path/to/file/to/add&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>or from the command line</p>
<blockquote>
<div><p>taxit update /path/to/refpkg key=/path/to/file/to/add</p>
</div></blockquote>
<p>Either way, <code class="docutils literal notranslate"><span class="pre">/path/to/file/to/add</span></code> is copied into the refpkg (and renamed if necessary so as not to collide with files already in the refpkg), and an entry added to the JSON file to assign <code class="docutils literal notranslate"><span class="pre">key</span></code> to the file.</p>
<p>Refpkgs also store metadata, in the form of a key-value store of arbitrary strings.  The metadata keys occupy a separate namespace from the file keys, so you can have both a file and a string assigned to the key <code class="docutils literal notranslate"><span class="pre">boris</span></code> at the same time.  Setting metadata with the API uses the method <code class="docutils literal notranslate"><span class="pre">update_metadata</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">update_metadata</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value to add&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>From the command line, use <code class="docutils literal notranslate"><span class="pre">taxit</span> <span class="pre">update</span></code>, but with the <code class="docutils literal notranslate"><span class="pre">--metadata</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">taxit</span> <span class="n">update</span> <span class="o">--</span><span class="n">metadata</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">refpkg</span> <span class="s2">&quot;key=value to add&quot;</span>
</pre></div>
</div>
<p>Refpkgs have an undo/redo mechanism.  If you update something incorrectly, you can call the <code class="docutils literal notranslate"><span class="pre">rollback</span></code> method of the API or the <code class="docutils literal notranslate"><span class="pre">rollback</span></code> subcommand of <code class="docutils literal notranslate"><span class="pre">taxit</span></code> to restore the refpkg to its previous state.  An improperly rolled back operation can be rolled forward again with <code class="docutils literal notranslate"><span class="pre">rollforward</span></code>.  So running the following in the API leaves the refpkg unchanged at the end:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">rollforward</span><span class="p">()</span>
</pre></div>
</div>
<p>Similarly with <code class="docutils literal notranslate"><span class="pre">taxit</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">taxit</span> <span class="n">rollback</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">refpkg</span>
<span class="n">taxit</span> <span class="n">rollforward</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">refpkg</span>
</pre></div>
</div>
<p>Before distributing a refpkg, you may want to strip out rollback/rollforward information and any unused files.  The <code class="docutils literal notranslate"><span class="pre">strip</span></code> method removes everything not necessary to the current state of the refpkg:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>
</div>
<p>or from the command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">taxit</span> <span class="n">strip</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">refpkg</span>
</pre></div>
</div>
<p>There is a method and a command, both called <code class="docutils literal notranslate"><span class="pre">check</span></code>, which check if a refpkg is usable as an input to <code class="docutils literal notranslate"><span class="pre">pplacer</span></code>.  Running <code class="docutils literal notranslate"><span class="pre">r.check()</span></code> from Python or <code class="docutils literal notranslate"><span class="pre">taxit</span> <span class="pre">check</span> <span class="pre">/path/to/refpkg</span></code> from the command line will fail, saying that there is no such key <code class="docutils literal notranslate"><span class="pre">aln_fasta</span></code> in the refpkg.</p>
</section>
<section id="the-refpkg-format">
<h2>The Refpkg format<a class="headerlink" href="#the-refpkg-format" title="Link to this heading">¶</a></h2>
<p>A refpkg is a crude key-value store for files with some basic integrity checking, machinery for undo and redo of operations, and a little bit of metadata storage.  The minimal refpkg consists of a directory containing a file names <code class="docutils literal notranslate"><span class="pre">CONTENTS.json</span></code>.  The JSON file must contain the following keys:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">files</span></code></dt><dd><p>A list of the files this refpkg is currently tracking in its directory.   The value must be a JSON object assigning keys to filenames in the directory, e.g. <code class="docutils literal notranslate"><span class="pre">{&quot;taxonomy&quot;:</span> <span class="pre">&quot;taxtable.csv&quot;}</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">md5</span></code></dt><dd><p>The value must be a JSON object with the same keys are <code class="docutils literal notranslate"><span class="pre">files</span></code>, but where the values are the MD5 sums of the files.  These fields are used to ensure the integrity of the files the refpkg is tracking.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">metadata</span></code></dt><dd><p>The value must be a JSON object containing keys referring to strings, e.g., <code class="docutils literal notranslate"><span class="pre">{&quot;author&quot;:</span> <span class="pre">&quot;Boris</span> <span class="pre">the</span> <span class="pre">mad</span> <span class="pre">baboon&quot;,</span> <span class="pre">&quot;create_date&quot;:</span> <span class="pre">&quot;2011-08-18</span> <span class="pre">14:50:39&quot;}</span></code>.  This is where any data describing the refpkg as a whole should be.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">log</span></code></dt><dd><p>The value must be a list of strings, e.g., <code class="docutils literal notranslate"><span class="pre">[&quot;Created</span> <span class="pre">package.&quot;,</span> <span class="pre">&quot;Oh</span> <span class="pre">god,</span> <span class="pre">get</span> <span class="pre">it</span> <span class="pre">off</span> <span class="pre">me!&quot;]</span></code>.  The various refpkg operations each append an entry to the log, so it records the history of what has been done to this refpkg.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rollback</span></code></dt><dd><p>Either <code class="docutils literal notranslate"><span class="pre">null</span></code> or the JSON object which was previously the top level object of <code class="docutils literal notranslate"><span class="pre">CONTENTS.json</span></code> before the last operation performed on this refpkg.  It is used to undo operations on a refpkg.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rollforward</span></code></dt><dd><p>When an operation is rolled back, the state before the rollback is preserved in <code class="docutils literal notranslate"><span class="pre">rollforward</span></code> so the undo can be redone.  <code class="docutils literal notranslate"><span class="pre">rollforward</span></code> is either <code class="docutils literal notranslate"><span class="pre">null</span></code> or a list of two entries, the first a string giving the log entry associated with the rolled back operation, the second the JSON object describing the contents before the rollback.</p>
</dd>
</dl>
<p>Any program only wanting to read refpkgs only needs to worry about the keys <code class="docutils literal notranslate"><span class="pre">files</span></code>, <code class="docutils literal notranslate"><span class="pre">md5</span></code>, and <code class="docutils literal notranslate"><span class="pre">metadata</span></code>.  Any file read from the refpkg should have its MD5 sum checked against the refpkg’s stored value.</p>
<p>The refpkg format was designed to store multiple alignments and trees with optional taxonomic information for use by <code class="docutils literal notranslate"><span class="pre">pplacer</span></code>, so certain fields are expected.</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">taxonomy</span></code></dt><dd><p>A CSV file giving a taxonomy that contains all the sequences included in the refpkg.  This is typically created with taxtastic’s <code class="docutils literal notranslate"><span class="pre">taxit</span> <span class="pre">taxtable</span></code> command.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">profile</span></code></dt><dd><p>The profile used by <code class="docutils literal notranslate"><span class="pre">cmalign</span></code> or <code class="docutils literal notranslate"><span class="pre">hmmalign</span></code> when aligning the sequences for <code class="docutils literal notranslate"><span class="pre">pplacer</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tree</span></code></dt><dd><p>A phylogenetic tree with the sequences in this refpkg as its nodes, stored in Newick format.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tree_stats</span></code></dt><dd><p>The output of the phylogenetic inference program describing its run when it assembled the phylogenetic tree for this refpkg.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">phylo_model</span></code></dt><dd><p>A JSON file describing the phylogenetic model used for tree construction, usually parsed from the information in <code class="docutils literal notranslate"><span class="pre">tree_stats</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">aln_fasta</span></code></dt><dd><p>A FASTA file containing all the sequences included in this refpkg.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">seq_info</span></code></dt><dd><p>A CSV file giving basic information on all the sequences included in the refpkg.  It should begin with one line giving the field names:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;seqname&quot;</span><span class="p">,</span><span class="s2">&quot;accession&quot;</span><span class="p">,</span><span class="s2">&quot;tax_id&quot;</span><span class="p">,</span><span class="s2">&quot;species_name&quot;</span><span class="p">,</span><span class="s2">&quot;is_type&quot;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">seqname</span></code> should match the ID of the sequence in the FASTA file.  <code class="docutils literal notranslate"><span class="pre">accession</span></code> is a database reference for the sequence, which can be the same as <code class="docutils literal notranslate"><span class="pre">seqname</span></code>.  In our work, <code class="docutils literal notranslate"><span class="pre">seqname</span></code> is an RDP accession number and <code class="docutils literal notranslate"><span class="pre">accession</span></code> is the NCBI accession number corresponding to that RDP entry.  <code class="docutils literal notranslate"><span class="pre">tax_id</span></code> is the entry in the taxonomy this sequence is mapped to, and <code class="docutils literal notranslate"><span class="pre">species_name</span></code> is the name associated with that entry.  <code class="docutils literal notranslate"><span class="pre">is_type</span></code> indicates whether this sequence is from a typestrain or not (again, this is particular to our work).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">aln_sto</span></code></dt><dd><p>The same sequences as in <code class="docutils literal notranslate"><span class="pre">aln_fasta</span></code>, but written in Stockholm format.</p>
</dd>
</dl>
<p>The files referred to by <code class="docutils literal notranslate"><span class="pre">aln_fasta</span></code>, <code class="docutils literal notranslate"><span class="pre">seq_info</span></code>, <code class="docutils literal notranslate"><span class="pre">aln_sto</span></code>, and <code class="docutils literal notranslate"><span class="pre">tree</span></code> should all have the same list of sequences.  This isn’t strictly enforced, but you can check that it is so with the <code class="docutils literal notranslate"><span class="pre">taxit</span> <span class="pre">check</span></code> command or the <code class="docutils literal notranslate"><span class="pre">is_ill_formed</span></code> method of the refpkg API.</p>
<p>The undo/redo system is implemented as a purely functional data structure known as a zipper, used as a replacement for arrays with a pointer into them as a cursor in languages where data is immutable.  A zipper consists of a current entry, a ordered list of previous entries, and an ordered list of subsequent entries.  Moving the cursor one place to the right is equivalent to pushing the current entry onto the head of the list of previous entries, and popping the head of the list of subsequent entries and making that the new current entry.  Moving the cursor one place to the left is exactly the opposite.</p>
<p>The top level object of <code class="docutils literal notranslate"><span class="pre">CONTENTS.json</span></code> plays the role of the current entry, and its fields <code class="docutils literal notranslate"><span class="pre">rollback</span></code> and <code class="docutils literal notranslate"><span class="pre">rollforward</span></code> are the heads of the lists of previous and subsequent entries.  The <code class="docutils literal notranslate"><span class="pre">rollback</span></code> field of the object in the <code class="docutils literal notranslate"><span class="pre">rollback</span></code> field is the second element of the list of previous entries, etc.  Thus undoing an operation consists of putting the current toplevel JSON object in the <code class="docutils literal notranslate"><span class="pre">rollforward</span></code> fields of the object in the <code class="docutils literal notranslate"><span class="pre">rollback</span></code> field, and making that object the new toplevel JSON object (with some book keeping details to keep everything consistent).</p>
<p>As a result of this, there may be files besides those referenced in the <code class="docutils literal notranslate"><span class="pre">files</span></code> key of the JSON object in the refpkg.  They may be referenced by other entries in the zipper.  There is no attempt to intelligently garbage collect orphaned files.  They are only deleted when the refpkg’s <code class="docutils literal notranslate"><span class="pre">strip</span></code> method is called, which removes all undo/redo information as well.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Creating and manipulating refpkgs</a><ul>
<li><a class="reference internal" href="#quickstart">Quickstart</a></li>
<li><a class="reference internal" href="#the-refpkg-format">The Refpkg format</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="taxonomy.html"
                          title="previous chapter">Manipulating the NCBI taxonomy</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="refpkg_api.html"
                          title="next chapter">The Python Refpkg API</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/refpkg.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="refpkg_api.html" title="The Python Refpkg API"
             >next</a> |</li>
        <li class="right" >
          <a href="taxonomy.html" title="Manipulating the NCBI taxonomy"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">taxtastic  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Creating and manipulating refpkgs</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2011-2024, Noah Hoffman, Erick Matsen, Brian Hodges, Connor McCoy, Chris Rosenthal.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    </div>
  </body>
</html>