
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>The Python Refpkg API &#8212; taxtastic 0.9.4 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/classic.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Detailed taxit documentation" href="commands.html" />
    <link rel="prev" title="Creating and manipulating refpkgs" href="refpkg.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="commands.html" title="Detailed taxit documentation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="refpkg.html" title="Creating and manipulating refpkgs"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">taxtastic 0.9.4 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">The Python Refpkg API</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="the-python-refpkg-api">
<h1>The Python Refpkg API<a class="headerlink" href="#the-python-refpkg-api" title="Permalink to this headline">¶</a></h1>
<p>Taxtastic provides a Python API for creating and manipulating refpkgs wihtout having to recourse to the command line.  It is entirely based around the <code class="docutils literal notranslate"><span class="pre">Refpkg</span></code> class in <code class="docutils literal notranslate"><span class="pre">taxtastic.refpkg</span></code>.  Thus all scripts dealing with refpkgs will include code that looks something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">taxtastic.refpkg</span> <span class="k">import</span> <span class="n">Refpkg</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">Refpkg</span><span class="p">(</span><span class="s1">&#39;/path/to/refpkg&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The constructor takes no other arguments.  If the refpkg at <code class="docutils literal notranslate"><span class="pre">/path/to/refpkg</span></code> already exists, <code class="docutils literal notranslate"><span class="pre">r</span></code> is attached to it.  If <code class="docutils literal notranslate"><span class="pre">/path/to/refpkg</span></code> does not exist, a new, empty refpkg is created.  If there is already something at <code class="docutils literal notranslate"><span class="pre">/path/to/refpkg</span></code>, but it is not a refpkg, <code class="docutils literal notranslate"><span class="pre">Refpkg</span></code> throws a <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>.</p>
<p>The rest of the API is implemented as methods of the <code class="docutils literal notranslate"><span class="pre">Refpkg</span></code> class.</p>
<p><strong>Note</strong>: This library is <em>not</em> thread safe!</p>
<section id="accessing-refpkg-contents">
<h2>Accessing refpkg contents<a class="headerlink" href="#accessing-refpkg-contents" title="Permalink to this headline">¶</a></h2>
<p>Refpkgs are primarily key-value stores for files and metadata.  To find all the keys referring to files or to metadata in a given refpkg, use the methods</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="n">Refpkg</span><span class="p">(</span><span class="s1">&#39;/path/to/new/refpkg&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">metadata_keys</span><span class="p">()</span>
 <span class="o">--&gt;</span> <span class="p">[</span><span class="s1">&#39;create_date&#39;</span><span class="p">,</span> <span class="s1">&#39;format_version&#39;</span><span class="p">]</span>
<span class="n">r</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span><span class="s1">&#39;file_key&#39;</span><span class="p">,</span> <span class="s1">&#39;/path/to/some/file&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">file_keys</span><span class="p">()</span>
 <span class="o">--&gt;</span> <span class="p">[</span><span class="s1">&#39;file_key&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Call the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> method to retrieve the value of a particular metadata field.</p>
<p>For instance, on the same refpkg as above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">metadata</span><span class="p">(</span><span class="s1">&#39;format_version&#39;</span><span class="p">)</span>
 <span class="o">--&gt;</span> <span class="s1">&#39;1.1&#39;</span>
</pre></div>
</div>
<p>There are several methods for working with the resources in a reference package.</p>
</section>
<section id="checking-refpkg-integrity">
<h2>Checking refpkg integrity<a class="headerlink" href="#checking-refpkg-integrity" title="Permalink to this headline">¶</a></h2>
<p>There are two methods for checking a refpkg.  The <code class="docutils literal notranslate"><span class="pre">is_invalid</span></code> method enforces only that the refpkg is sane: there is a <code class="docutils literal notranslate"><span class="pre">CONTENTS.json</span></code> file, the MD5 sums listed match the actual files, and other such basics.  The <code class="docutils literal notranslate"><span class="pre">is_ill_formed</span></code> method is much stronger.  It enforces the necessary structure of a refpkg to be fed to <a class="reference external" href="http://matsen.fhcrc.org/pplacer">pplacer</a>.</p>
</section>
<section id="updating-and-modifying-refpkgs">
<h2>Updating and modifying refpkgs<a class="headerlink" href="#updating-and-modifying-refpkgs" title="Permalink to this headline">¶</a></h2>
<p>All updates are made via two methods: <code class="docutils literal notranslate"><span class="pre">update_metadata</span></code> and <code class="docutils literal notranslate"><span class="pre">update_file</span></code>.  Each takes a key and a new value to set at that key, and returns the path to the previous value of the key, or <code class="docutils literal notranslate"><span class="pre">None</span></code> if the key was not previously defined in the refpkg.</p>
</section>
<section id="refpkg-history-undo-and-redo">
<h2>Refpkg history, undo, and redo<a class="headerlink" href="#refpkg-history-undo-and-redo" title="Permalink to this headline">¶</a></h2>
<p>Each operation performed on a refpkg leaves an entry in a log stored in <code class="docutils literal notranslate"><span class="pre">CONTENTS.json</span></code>.  You can access this log by calling the <code class="docutils literal notranslate"><span class="pre">log</span></code> method.</p>
<p>Each operation call also be undone (and redone once undone).  The undo stack is arbitrarily deep so all operations back to the previous call to <code class="docutils literal notranslate"><span class="pre">strip</span></code> (see below) can be undone.  To undo an operation, call <code class="docutils literal notranslate"><span class="pre">rollback</span></code>.  To redo it afterwards, call <code class="docutils literal notranslate"><span class="pre">rollforward</span></code>.  The logs will similarly be updated to stay in sync with the rollback and rollforward of operations.  Note that when you call another operation, all the redo information before that point is removed.  You cannot undo an operation, perform another operation, then redo the first operation.</p>
<p>After performing a lot of operations on a refpkg, there will often be a long undo history, and files no longer referred to in the refpkg’s current state.  To remove everything not relevant to the refpkg’s current state other than the log, call the <code class="docutils literal notranslate"><span class="pre">strip</span></code> method.</p>
<p>You can force a series of operations to be recorded as a single operation for rollback and have a single log entry by calling <code class="docutils literal notranslate"><span class="pre">start_transaction</span></code> before them, and <code class="docutils literal notranslate"><span class="pre">commit_transaction</span></code> with the log entry to record when they are done.</p>
<p>For example,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">taxtastic.refpkg</span> <span class="k">import</span> <span class="n">Refpkg</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">Refpkg</span><span class="p">(</span><span class="s1">&#39;/path/to/refpkg&#39;</span><span class="p">)</span>

<span class="n">r</span><span class="o">.</span><span class="n">start_transaction</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">update_metadata</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;Boris the mad baboon&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">update_file</span><span class="p">(</span><span class="s1">&#39;boris_signature&#39;</span><span class="p">,</span> <span class="s1">&#39;/path/to/some/file&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">commit_transaction</span><span class="p">(</span><span class="s2">&quot;Left Boris&#39;s mark!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>would result in a single operation that could be rolled back as one, and leaves the log entry <code class="docutils literal notranslate"><span class="pre">&quot;Left</span> <span class="pre">Boris's</span> <span class="pre">mark!&quot;</span></code>.</p>
</section>
<section id="pplacer-specific-commands">
<h2><code class="docutils literal notranslate"><span class="pre">pplacer</span></code> specific commands<a class="headerlink" href="#pplacer-specific-commands" title="Permalink to this headline">¶</a></h2>
<p>Finally, the API has three commands which are specific to creating inputs for <a class="reference external" href="http://matsen.fhcrc.org/pplacer">pplacer</a>.  One of these is <code class="docutils literal notranslate"><span class="pre">check</span></code>, which was described above.  The other two are:</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">The Python Refpkg API</a><ul>
<li><a class="reference internal" href="#accessing-refpkg-contents">Accessing refpkg contents</a></li>
<li><a class="reference internal" href="#checking-refpkg-integrity">Checking refpkg integrity</a></li>
<li><a class="reference internal" href="#updating-and-modifying-refpkgs">Updating and modifying refpkgs</a></li>
<li><a class="reference internal" href="#refpkg-history-undo-and-redo">Refpkg history, undo, and redo</a></li>
<li><a class="reference internal" href="#pplacer-specific-commands"><code class="docutils literal notranslate"><span class="pre">pplacer</span></code> specific commands</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="refpkg.html"
                          title="previous chapter">Creating and manipulating refpkgs</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="commands.html"
                          title="next chapter">Detailed <code class="docutils literal notranslate"><span class="pre">taxit</span></code> documentation</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/refpkg_api.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="commands.html" title="Detailed taxit documentation"
             >next</a> |</li>
        <li class="right" >
          <a href="refpkg.html" title="Creating and manipulating refpkgs"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">taxtastic 0.9.4 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">The Python Refpkg API</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2011-2022, Noah Hoffman, Erick Matsen, Brian Hodges, Connor McCoy, Chris Rosenthal.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>